name: Pixel OS

on:
  workflow_dispatch:
    inputs:
      RELEASE_CONFIG:
        description: 'Upload to Releases'
        required: true
        default: true
        type: boolean
      KERNEL_SOURCE:
        description: 'Kernel Source'
        required: true
        default: "https://github.com/beet-stuffs/android_kernel_oneplus_sm8350.git"
        type: string
      KERNEL_SOURCE_BRANCH:
        description: 'Kernel Branch'
        required: true
        default: "fourteen-qpr2"
        type: string
      KERNEL_DEFCONFIG:
        description: 'Kernel Config'
        required: true
        default: "vendor/lahaina-qgki_defconfig"
        type: string
      KERNELSU_CONFIG:
        description: 'Compile KernelSU'
        required: true
        default: true
        type: boolean
      KERNELSU_TAG:
        description: 'KernelSU tag / commit'
        required: false
        default: "a943528d8203f2bcd524bddb273fb3c00905ea67"
        type: string

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison flex ccache \
            libssl-dev libelf-dev \
            build-essential \
            python3 python-is-python3

      - name: Setup AOSP Clang (Android 16)
        run: |
          mkdir -p $GITHUB_WORKSPACE/toolchain
          cd $GITHUB_WORKSPACE/toolchain

          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/tags/android-16.0.0_r4/clang-r547379.tar.gz
          tar -xf clang-r547379.tar.gz

          echo "PATH=$GITHUB_WORKSPACE/toolchain/bin:$PATH" >> $GITHUB_ENV

      - name: Clone kernel source
        run: |
          git clone "${{ github.event.inputs.KERNEL_SOURCE }}" \
            -b "${{ github.event.inputs.KERNEL_SOURCE_BRANCH }}" \
            kernel --depth=1

          echo "TAG_NAME=v5.4.$(grep '^SUBLEVEL =' kernel/Makefile | awk '{print $3}')-$(date +'%Y%m%d')" >> $GITHUB_ENV

      - name: Setup KernelSU
        if: github.event.inputs.KERNELSU_CONFIG == 'true'
        run: |
          cd kernel
          curl -LSs https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh | \
            bash -s "${{ github.event.inputs.KERNELSU_TAG }}"

          scripts/config --file arch/arm64/configs/${{ github.event.inputs.KERNEL_DEFCONFIG }} \
            -e MODULES -e KPROBES -e HAVE_KPROBES -e KPROBE_EVENTS

      - name: Build kernel (LLVM, Android 16)
        run: |
          cd kernel

          export ARCH=arm64
          export LLVM=1
          export LLVM_IAS=1

          make O=out ${{ github.event.inputs.KERNEL_DEFCONFIG }}

          # Disable LTO for GitHub runners (LLVM 18+ can OOM)
          scripts/config --file out/.config \
            -d LTO -d LTO_CLANG -d THINLTO -e LTO_NONE

          make O=out -j$(nproc)

      - name: Create AnyKernel3 zip
        run: |
          cd kernel
          git clone https://gitlab.com/inferno0230/AnyKernel3.git --depth=1

          cp out/arch/arm64/boot/Image AnyKernel3/
          cd AnyKernel3

          ZIP_NAME=PixelOS-martini-${{ env.TAG_NAME }}.zip
          zip -r $ZIP_NAME *
          mv $ZIP_NAME ../out/arch/arm64/boot/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PixelOS-martini-${{ env.TAG_NAME }}
          path: kernel/out/arch/arm64/boot/*.zip

      - name: Upload to Release
        if: github.event.inputs.RELEASE_CONFIG == 'true'
        uses: ncipollo/release-action@v1
        with:
          artifacts: kernel/out/arch/arm64/boot/*.zip
          tag: ONEPLUS9RT-PixelOS-${{ env.TAG_NAME }}
          name: PixelOS martini ${{ env.TAG_NAME }}
          allowUpdates: true
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
